const express=require("express"),path=require("path"),fs=require("fs"),sharp=require("sharp"),multer=require("multer"),router=express.Router(),projectRoot=path.join(__dirname,"../../.."),imgDir=path.join(projectRoot,"/public/images");function createUniqueFolder(baseName){let folderPath=path.join(imgDir,baseName),counter=1;for(;fs.existsSync(folderPath);)folderPath=path.join(imgDir,`${baseName}(${counter++})`);return fs.mkdirSync(folderPath,{recursive:!0}),folderPath}fs.existsSync(imgDir)||fs.mkdirSync(imgDir,{recursive:!0});const fileFilter=(req,file,cb)=>{const allowedTypes=/jpeg|jpg|png|gif|webp/,extname=allowedTypes.test(path.extname(file.originalname).toLowerCase()),mimetype=allowedTypes.test(file.mimetype);cb(null,!(!extname||!mimetype))},storage=multer.diskStorage({destination:(req,file,cb)=>{if(!req.uploadFolder){const baseName=file.originalname||"images";req.uploadFolder=createUniqueFolder(baseName)}cb(null,req.uploadFolder)},filename:(req,file,cb)=>{cb(null,"image"+path.extname(file.originalname))}}),upload=multer({storage:storage,limits:{fileSize:5242880},fileFilter:(req,file,cb)=>{const allowedTypes=/jpeg|jpg|png|gif|webp/,extname=allowedTypes.test(path.extname(file.originalname).toLowerCase()),mimetype=allowedTypes.test(file.mimetype);extname&&mimetype?cb(null,!0):cb(new Error("Only image files are allowed (jpg, png, webp, gif)."))}});router.use("/static",express.static(path.join(projectRoot,"/views/backend/pages/media_manager"))),router.get("/",((req,res)=>{res.render("./backend/pages/media_manager/index",{title:"Media Manager",layout:"backend/layout/main"})})),router.get("/getmedia",((req,res)=>{res.json([{id:1,name:"img1",path:"/static/images/img1/thumbs.png"},{id:2,name:"img2",path:"/static/images/img2/thumbs.jpg"}])})),router.post("/addmedia",((req,res)=>{upload.array("images",10)(req,res,(err=>{if(err)return res.status(400).json({success:!1,message:err.message});const uploadedFiles=req.files.map((file=>({filename:file.filename,path:file.path})));res.json({folder:req.uploadFolder,files:uploadedFiles})}))})),router.post("/removemedia",((req,res)=>{const{id:id}=req.body;console.log("hello",req.params,id,req.query?.id),res.json({status:"success"})})),module.exports=router;